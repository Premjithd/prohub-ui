<div class="job-details-wrapper">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <button mat-button (click)="goBack()" mat-raised-button color="primary">
        <mat-icon>arrow_back</mat-icon>
        Back to Jobs
      </button>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="alert alert-error">
    <mat-icon>error</mat-icon>
    <span>{{ errorMessage }}</span>
  </div>

  <!-- Success Message -->
  <div *ngIf="bidSuccess" class="alert alert-success">
    <mat-icon>check_circle</mat-icon>
    <span>Successfully submitted your interest in this job!</span>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading job details...</p>
  </div>

  <!-- Job Details Content -->
  <div *ngIf="!loading && job" class="job-details-container">
    <div class="job-details-card">
      <!-- Job Header -->
      <div class="job-header">
        <div class="job-title-section">
          <h1 class="job-title">{{ job.title }}</h1>
          <div class="job-meta">
            <span class="job-category">{{ job.category?.name || 'Uncategorized' }}</span>
            <span class="job-status" [class.status-open]="job.status === 'Open'">
              {{ job.status }}
            </span>
          </div>
        </div>
        <div class="job-budget">
          <span class="budget-label">Budget</span>
          <span class="price">{{ formatPrice(job.budget) }}</span>
        </div>
      </div>

      <!-- Job Content -->
      <div class="job-content">
        <!-- Description Section -->
        <section class="job-section">
          <h2>Description</h2>
          <p class="description">{{ job.description }}</p>
        </section>

        <!-- Job Details Grid -->
        <section class="job-details-grid">
          <div class="detail-box">
            <div class="detail-header">
              <mat-icon>location_on</mat-icon>
              <h3>Location</h3>
            </div>
            <p class="detail-value">{{ job.location }}</p>
          </div>

          <div class="detail-box">
            <div class="detail-header">
              <mat-icon>schedule</mat-icon>
              <h3>Timeline</h3>
            </div>
            <p class="detail-value">{{ job.timeline }}</p>
          </div>

          <div class="detail-box">
            <div class="detail-header">
              <mat-icon>calendar_today</mat-icon>
              <h3>Posted Date</h3>
            </div>
            <p class="detail-value">{{ job.createdAt | date: 'MMM dd, yyyy HH:mm' }}</p>
          </div>

          <div class="detail-box">
            <div class="detail-header">
              <mat-icon>person</mat-icon>
              <h3>Posted By</h3>
            </div>
            <p class="detail-value">
              {{ job?.user?.firstName && job?.user?.lastName ? (job?.user?.firstName + ' ' + job?.user?.lastName) : (job?.user?.name || 'User') }}
            </p>
          </div>
        </section>

        <!-- Attachments Section (if available) -->
        <section *ngIf="job.attachments" class="job-section">
          <h2>Attachments</h2>
          <div class="attachments">
            <div class="attachment-item">
              <mat-icon>attach_file</mat-icon>
              <span>{{ job.attachments }}</span>
            </div>
          </div>
        </section>

        <!-- Status Information -->
        <section class="job-section status-section">
          <h2>Status Information</h2>
          <div class="status-info">
            <div class="info-item">
              <span class="info-label">Current Status:</span>
              <span class="info-value" [class.status-open]="job.status === 'Open'">{{ job.status }}</span>
            </div>
            <div *ngIf="job.assignedProId" class="info-item">
              <span class="info-label">Assigned to:</span>
              <span class="info-value">
                {{ job?.assignedPro?.proName ? job?.assignedPro?.proName : 'Professional' }}
              </span>
            </div>
            <div *ngIf="!job.assignedProId" class="info-item">
              <span class="info-label">Assignment Status:</span>
              <span class="info-value status-unassigned">Unassigned - Available for Pro Bid</span>
            </div>
            <div class="info-item">
              <span class="info-label">Your Bid Status:</span>
              <div *ngIf="!userHasBid" class="bid-status-container">
                <span class="info-value">Not yet bid</span>
              </div>
              <div *ngIf="userHasBid" class="bid-status-container bid-submitted" [class.bid-rejected]="userBidStatus === 'Rejected'">
                <div class="bid-status-header">
                  <mat-icon [class.rejected-icon]="userBidStatus === 'Rejected'">{{ userBidStatus === 'Rejected' ? 'cancel' : 'check_circle' }}</mat-icon>
                  <span class="bid-status-text">{{ userBidStatus === 'Rejected' ? 'Bid Rejected' : 'Bid Submitted' }}</span>
                </div>
                <div class="bid-details">
                  <div *ngIf="userBidAmount" class="bid-detail-item">
                    <span class="bid-detail-label">Your Proposed Amount:</span>
                    <span class="bid-detail-value amount">${{ userBidAmount | number: '1.2-2' }}</span>
                  </div>
                  <div *ngIf="userBidMessage" class="bid-detail-item">
                    <span class="bid-detail-label">Your Message:</span>
                    <p class="bid-detail-value message">{{ userBidMessage }}</p>
                  </div>
                </div>
                <div *ngIf="userBidStatus === 'Rejected' && job.status === 'Open'" class="bid-resubmit-section">
                  <p class="resubmit-message">Your bid was not accepted. You can try submit a new bid.</p>
                  <button mat-raised-button color="accent" (click)="submitBid()">
                    <mat-icon>refresh</mat-icon>
                    Submit New Bid
                  </button>
                </div>
              </div>
            </div>

            <!-- Message History Section -->
            <div class="info-item" *ngIf="userHasBid && jobMessages.length > 0">
              <span class="info-label">Message History:</span>
              <div class="messages-section">
                <!-- Loading State -->
                <div *ngIf="loadingMessages" class="messages-loading">
                  <mat-spinner diameter="20"></mat-spinner>
                  <p>Loading messages...</p>
                </div>

                <!-- Messages List -->
                <div *ngIf="!loadingMessages && jobMessages.length > 0" class="messages-list">
                  <div *ngFor="let msg of jobMessages" class="message-item" [class.sent]="msg.senderType === 'Pro'">
                    <div class="message-header">
                      <span class="sender-type">{{ msg.senderType === 'Pro' ? 'You' : 'Job Poster' }}</span>
                      <span class="message-time">{{ msg.sentAt | date: 'MMM dd, HH:mm' }}</span>
                    </div>
                    <p class="message-content">{{ msg.content }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Action Buttons -->
        <div class="job-actions">
        <button mat-raised-button color="primary" class="full-width" (click)="submitBid()" [disabled]="submittingBid || userHasBid">
          <mat-icon *ngIf="!submittingBid && !userHasBid">handshake</mat-icon>
          <mat-icon *ngIf="userHasBid">check_circle</mat-icon>
          <mat-spinner *ngIf="submittingBid" diameter="20" class="button-spinner"></mat-spinner>
          {{ userHasBid ? 'Already Bid on This Job' : (submittingBid ? 'Submitting...' : 'Send a Bid') }}
        </button>
        <button mat-button (click)="goBack()" class="full-width">
          <mat-icon>arrow_back</mat-icon>
          Back to Available Jobs
        </button>
      </div>
    </div>
  </div>
</div>
